/*! Zeptor/jQuery RPC - v0.2.0 - 2013-03-31
* https://github.com/torworx/rpc
* Copyright 2013 Tao Yuan; Licensed MIT */
(function(t){function e(t){return null!==t&&t==t.window}function r(t){return"object"==o(t)}function n(t){if(!t||"object"!==o(t)||t.nodeType||e(t))return!1;try{if(t.constructor&&!g.call(t,"constructor")&&!g.call(t.constructor.prototype,"isPrototypeOf"))return!1}catch(r){return!1}var n;for(n in t);return void 0===n||g.call(t,n)}function a(t){return t instanceof Array}function i(t){return"number"==typeof t.length}function o(t){return null===t?t+"":p[h.call(t)]||"object"}function s(t,e,r){for(var i in e)r&&(n(e[i])||a(e[i]))?(n(e[i])&&!n(t[i])&&(t[i]={}),a(e[i])&&!a(t[i])&&(t[i]=[]),s(t[i],e[i],r)):void 0!==e[i]&&(t[i]=e[i])}function u(t,e,r,n){var a,i=$.isArray(e);m.each(e,function(e,o){a=m.type(o),n&&(e=r?n:n+"["+(i?"":e)+"]"),!n&&i?t.add(o.name,o.value):"array"==a||!r&&"object"==a?u(t,o,r,e):t.add(e,o)})}var c=t.rpc,l=Array.prototype,f=l.slice,p={},h=p.toString,g=p.hasOwnProperty,m=function(t,e){return new m.Service(t,e)};m.type=o,m.isPlainObject=n,m.isWindow=e,m.isObject=r,m.isArray=a,m.each=function(t,e){var r,n;if(i(t)){for(r=0;t.length>r;r++)if(e.call(t[r],r,t[r])===!1)return t}else for(n in t)if(e.call(t[n],n,t[n])===!1)return t;return t},m.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(t,e){p["[object "+e+"]"]=e.toLowerCase()}),m.extend=function(t){var e,r=f.call(arguments,1);return"boolean"==typeof t&&(e=t,t=r.shift()),r.forEach(function(r){s(t,r,e)}),t};var v=encodeURIComponent;m.param=function(t,e){var r=[];return r.add=function(t,e){this.push(v(t)+"="+v(e))},u(r,t,e),r.join("&").replace(/%20/g,"+")};var y=function(e,r){var n=f.call(arguments,2),a="string"===o(r);return function(){var i=f.call(arguments),o=a?(e||t)[r]:r;return o&&o.apply(e||this,n.concat(i))}};m.hitch=function(e,r){if(arguments.length>2)return y.apply(null,arguments);if(r||(r=e,e=null),"string"===o(r)){if(e=e||t,!e[r])throw['hitch: scope["',r,'"] is null (scope="',e,'")'].join("");return function(){return e[r].apply(e,arguments||[])}}return e?function(){return r.apply(e,arguments||[])}:r};var d=RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),O=RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$"),j=m.Url=function(){for(var t=null,e=arguments,r=[e[0]],n=1;e.length>n;n++)if(e[n]){var a=new j(e[n]+""),i=new j(r[0]+"");if(""!==a.path||a.scheme||a.authority||a.query){if(!a.scheme&&(a.scheme=i.scheme,!a.authority&&(a.authority=i.authority,"/"!=a.path.charAt(0)))){for(var o=i.path.substring(0,i.path.lastIndexOf("/")+1)+a.path,s=o.split("/"),u=0;s.length>u;u++)"."==s[u]?u==s.length-1?s[u]="":(s.splice(u,1),u--):u>0&&(1!=u||""!==s[0])&&".."==s[u]&&".."!=s[u-1]&&(u==s.length-1?(s.splice(u,1),s[u-1]=""):(s.splice(u-1,2),u-=2));a.path=s.join("/")}}else a.fragment!=t&&(i.fragment=a.fragment),a=i;r=[],a.scheme&&r.push(a.scheme,":"),a.authority&&r.push("//",a.authority),r.push(a.path),a.query&&r.push("?",a.query),a.fragment&&r.push("#",a.fragment)}this.uri=r.join("");var c=this.uri.match(d);this.scheme=c[2]||(c[1]?"":t),this.authority=c[4]||(c[3]?"":t),this.path=c[5],this.query=c[7]||(c[6]?"":t),this.fragment=c[9]||(c[8]?"":t),this.authority!=t&&(c=this.authority.match(O),this.user=c[3]||t,this.password=c[4]||t,this.host=c[6]||c[7],this.port=c[9]||t)};j.prototype.toString=function(){return this.uri};var S=m.AdapterRegistry=function(t){this.pairs=[],this.returnWrappers=t||!1};m.extend(S.prototype,{register:function(t,e,r,n,a){this.pairs[a?"unshift":"push"]([t,e,r,n])},match:function(){for(var t=0;this.pairs.length>t;t++){var e=this.pairs[t];if(e[1].apply(this,arguments))return e[3]||this.returnWrappers?e[2]:e[2].apply(this,arguments)}throw Error("No match found for '"+arguments[0]+"'")},unregister:function(t){for(var e=0;this.pairs.length>e;e++){var r=this.pairs[e];if(r[0]==t)return this.pairs.splice(e,1),!0}return!1}}),m.async=!0,m.noConflict=function(){return t.rpc===m&&(t.rpc=c),m},m.ajax=function(){alert("No adapter has been installed.")},m.installInto=function(t,e){t.rpc=m,m.ajax=t.ajax,e&&m.noConflict()},t.rpc=m})(window),function(rpc){"use strict";var _JSON,hasJSON="undefined"!=typeof JSON,hasJSONStringify=hasJSON&&'{"a":1}'==JSON.stringify({a:0},function(t,e){return e||1});if(hasJSONStringify)_JSON={parse:JSON.parse,stringify:JSON.stringify};else{var escapeString=function(t){return('"'+t.replace(/(["\\])/g,"\\$1")+'"').replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r")};_JSON={parse:hasJSON?JSON.parse:function(str,strict){if(strict&&!/^([\s\[\{]*(?:"(?:\\.|[^"])+"|-?\d[\d\.]*(?:[Ee][+-]?\d+)?|null|true|false|)[\s\]\}]*(?:,|:|$))+$/.test(str))throw new SyntaxError("Invalid characters in JSON");return eval("("+str+")")},stringify:function(t,e,r){function n(t,i,o){e&&(t=e(o,t));var s,u=typeof t;if("number"==u)return isFinite(t)?t+"":"null";if("boolean"==u)return t+"";if(null===t)return"null";if("string"==typeof t)return escapeString(t);if("function"==u||"undefined"==u)return a;if("function"==typeof t.toJSON)return n(t.toJSON(o),i,o);if(t instanceof Date)return'"{FullYear}-{Month+}-{Date}T{Hours}:{Minutes}:{Seconds}Z"'.replace(/\{(\w+)(\+)?\}/g,function(e,r,n){var a=t["getUTC"+r]()+(n?1:0);return 10>a?"0"+a:a});if(t.valueOf()!==t)return n(t.valueOf(),i,o);var c=r?i+r:"",l=r?" ":"",f=r?"\n":"";if(t instanceof Array){var p=t.length,h=[];for(o=0;p>o;o++){var g=t[o];s=n(g,c,o),"string"!=typeof s&&(s="null"),h.push(f+c+s)}return"["+h.join(",")+f+i+"]"}var m=[];for(o in t){var v;if(t.hasOwnProperty(o)){if("number"==typeof o)v='"'+o+'"';else{if("string"!=typeof o)continue;v=escapeString(o)}if(s=n(t[o],c,o),"string"!=typeof s)continue;m.push(f+c+v+":"+l+s)}}return"{"+m.join(",")+f+i+"}"}var a;return"string"==typeof e&&(r=e,e=null),n(t,"","")}}}_JSON.fromJson=function(js){return eval("("+js+")")};var toJsonIndentStr="	";_JSON.toJson=function(t,e){return _JSON.stringify(t,function(t,e){if(e){var r=e.__json__||e.json;if("function"==typeof r)return r.call(e)}return e},e&&toJsonIndentStr)},rpc.extend(rpc,_JSON)}(rpc),function(t){var e,r,n,a,i,o,s,u,c,l,f,p=[].slice;r="pending",a="resolved",n="rejected",u=function(t,e){return null!==t?t.hasOwnProperty(e):void 0},c=function(t){return u(t,"length")&&u(t,"callee")},s=function(t){return c(t)?s(Array.prototype.slice.call(t)):Array.isArray(t)?t.reduce(function(t,e){return Array.isArray(e)?t.concat(s(e)):(t.push(e),t)},[]):[t]},i=function(t,e){return 0>=t?e():function(){return 1>--t?e.apply(this,arguments):void 0}},l=function(t,e){return function(){var r;return r=[t].concat(Array.prototype.slice.call(arguments,0)),e.apply(this,r)}},o=function(t,e,r){var n,a,i,o,u;for(o=s(t),u=[],a=0,i=o.length;i>a;a++)n=o[a],u.push(n.call.apply(n,[r].concat(p.call(e))));return u},e=function(){var t,i,u,c,l,f;return f=r,c=[],l=[],t=[],u={},this.promise=function(i){var p,h;return i=i||{},i.state=function(){return f},h=function(t,e){return function(){return f===r&&e.push.apply(e,s(arguments)),t()&&o(arguments,u),i}},p=function(t,r){var n,a;return n=new e,a=function(t,e,r){return r?t(function(){return e(r.apply(null,arguments))}):t(function(){return e.apply(null,arguments)})},a(i.done,n.resolve,t),a(i.fail,n.reject,r),n},i.done=h(function(){return f===a},c),i.fail=h(function(){return f===n},l),i.always=h(function(){return f!==r},t),i.pipe=p,i.then=p,i},this.promise(this),i=function(e,n,a){return function(){return f===r&&(f=e,u=arguments,o([n,t],u,a)),this}},this.resolve=i(a,c),this.reject=i(n,l),this.resolveWith=function(){var t,e;return e=arguments[0],t=arguments.length>=2?p.call(arguments,1):[],i(a,c,e).apply(null,t)},this.rejectWith=function(){var t,e;return e=arguments[0],t=arguments.length>=2?p.call(arguments,1):[],i(n,l,e).apply(null,t)},this},f=function(){var t,r,n,a,o,u,c,l,f;for(o=new e,r=s(arguments),n=i(r.length,o.resolve),u=0,l=r.length;l>u;u++)t=r[u],t.done(n);for(a=function(){return o.reject()},c=0,f=r.length;f>c;c++)t=r[c],t.fail(a);return o.promise()},t.defer=function(){return new e},t.defer.when=f}(rpc),function(t){var e=t.Service=function(e,r){function n(e){var r;e._baseUrl=new t.Url(location.href,a||".")+"",i._smd=e;for(var n in i._smd.services){r=n.split(".");for(var o=i,s=0;r.length-1>s;s++)o=o[r[s]]||(o[r[s]]={});o[r[r.length-1]]=i._generateService(n,i._smd.services[n])}}var a,i=this;e&&("string"===t.type(e)||e instanceof t.Url?(a=e instanceof t.Url?e+"":e,t.ajax({url:a,async:!1,success:function(e){n(t.fromJson(e))},error:function(t,e,r){throw r}})):n(e)),this._options=r?r:{},this._requestId=0};t.extend(e.prototype,{_generateService:function(e,r){if(this[r])throw Error("WARNING: "+e+" already exists for service. Unable to generate function");r.name=e;var n=t.hitch(this,"_executeMethod",r),a=t.transportRegistry.match(r.transport||this._smd.transport);a.getExecutor&&(n=a.getExecutor(n,r,this));var i=r.returns||(r._schema={}),o="/"+e+"/";return i._service=n,n.servicePath=o,n._schema=i,n.id=t.Service._nextId++,n},_getRequest:function(e,r){var n,a,i=this._smd,o=t.envelopeRegistry.match(e.envelope||i.envelope||"NONE"),s=(e.parameters||[]).concat(i.parameters||[]);if(o.namedParams){if(1==r.length&&t.isPlainObject(r[0]))r=r[0];else{var u={};for(n=0;e.parameters.length>n;n++)void 0===r[n]&&e.parameters[n].optional||(u[e.parameters[n].name]=r[n]);r=u}if(e.strictParameters||i.strictParameters)for(n in r){var c=!1;for(a=0;s.length>a;a++)s[n].name==n&&(c=!0);c||delete r[n]}for(n=0;s.length>n;n++){var l=s[n];if(!l.optional&&l.name&&!r[l.name])if(l["default"])r[l.name]=l["default"];else if(!(l.name in r))throw Error("Required parameter "+l.name+" was omitted")}}else s&&s[0]&&s[0].name&&1==r.length&&t.isPlainObject(r[0])&&(r=o.namedParams===!1?t.toOrdered(s,r):r[0]);t.isPlainObject(this._options)&&(r=t.extend(r,this._options));var f=e._schema||e.returns,p=o.serialize.apply(this,[i,e,r]);p._envDef=o;var h=e.contentType||i.contentType||p.contentType;return t.extend(p,{async:t.async,contentType:h,headers:e.headers||i.headers||p.headers||{},target:p.target||t.getTarget(i,e),transport:e.transport||i.transport||p.transport,envelope:e.envelope||i.envelope||p.envelope,timeout:e.timeout||i.timeout,callbackParamName:e.callbackParamName||i.callbackParamName,rpcObjectParamName:e.rpcObjectParamName||i.rpcObjectParamName,schema:f,handleAs:p.handleAs||"auto",preventCache:e.preventCache||i.preventCache,frameDoc:this._options.frameDoc||void 0})},_executeMethod:function(e){for(var r=[],n=1;arguments.length>n;n++)r.push(arguments[n]);var a=this._getRequest(e,r),i=t.defer();return t.transportRegistry.match(a.transport).fire(t.extend({},a,{success:function(t){var e=a._envDef.deserialize.call(this,t);e instanceof Error?i.resolve(e,null):i.resolve(null,e)},error:function(t,e,r){i.resolve(r,null)}})),i}}),t.getTarget=function(e,r){var n=e._baseUrl;return e.target&&(n=new t.Url(n,e.target)+""),r.target&&(n=new t.Url(n,r.target)+""),n},t.toOrdered=function(e,r){if("array"===t.type(r))return r;for(var n=[],a=0;e.length>a;a++)n.push(r[e[a].name]);return n},t.transportRegistry=new t.AdapterRegistry(!0),t.envelopeRegistry=new t.AdapterRegistry(!0),t.envelopeRegistry.register("URL",function(t){return"URL"==t},{serialize:function(e,r,n){var a=t.param(n);return{data:a,transport:"POST"}},deserialize:function(t){return t},namedParams:!0}),t.envelopeRegistry.register("JSON",function(t){return"JSON"==t},{serialize:function(e,r,n){var a=t.toJson(n);return{data:a,dataType:"json",contentType:"application/json; charset=utf-8"}},deserialize:function(t){return t}}),t.envelopeRegistry.register("PATH",function(t){return"PATH"==t},{serialize:function(e,r,n){var a,i=t.getTarget(e,r);if("array"===t.type(n))for(a=0;n.length>a;a++)i+="/"+n[a];else for(a in n)i+="/"+a+"/"+n[a];return{data:"",target:i}},deserialize:function(t){return t}}),t.transportRegistry.register("POST",function(t){return"POST"==t},{fire:function(e){return e.url=e.target,e.type="POST",t.ajax(e)}}),t.transportRegistry.register("GET",function(t){return"GET"==t},{fire:function(e){return e.url=e.target+(e.data?"?"+(e.rpcObjectParamName?e.rpcObjectParamName+"=":"")+e.data:""),e.type="GET",e.data="",t.ajax(e)}}),t.transportRegistry.register("JSONP",function(t){return"JSONP"==t},{fire:function(e){return e.url=e.target+(-1==e.target.indexOf("?")?"?":"&")+(e.rpcObjectParamName?e.rpcObjectParamName+"=":"")+e.data,e.data="",e.dataType="jsonp",e.jsonp=e.callbackParamName||"callback",t.ajax(e)}}),t.Service._nextId=1,t.service=function(t,r){return new e(t,r)}}(rpc),function(t){function e(e,r,n,a){var i=t.defer(),o={type:e,success:function(t,e,r){a&&(a=r.getResponseHeader("Content-Range"),i.fullLength=a&&(a=a.match(/\/(.*)/))&&parseInt(a[1],0)),i.resolve(null,t)},error:function(t,e,r){i.resolve(r,null)}};return t.ajax(t.extend(o,r)),i}t&&t.transportRegistry&&t.transportRegistry.register("REST",function(t){return"REST"==t},{getExecutor:function(e,r,n){return new t.Rest(r.name,(r.contentType||n._smd.contentType||"").match(/json|javascript/),null,function(e,a){var i=n._getRequest(r,[]);return i.url=i.target+(e?"?"+t.param(e):""),a&&(a.start>=0||a.count>=0)&&(i.headers=i.headers||{},i.headers.Range="items="+(a.start||"0")+"-"+("count"in a&&1/0!=a.count?a.count+(a.start||0)-1:"")),i})}});var r;return r=t.Rest=function(e,n,a,i){function o(t){s[t]=function(e,n){return r._change(t,s,e,n)}}var s;return s=function(t,e){return r._get(s,t,e)},s.isJson=n,s._schema=a,s.cache={serialize:n?t.toJson:function(t){return t}},s._getRequest=i||function(r,a){if(t.isPlainObject(r)&&(r=t.param(r),r=r?"?"+r:""),a&&a.sort&&!a.queryStr){r+=(r?"&":"?")+"sort(";for(var i=0;a.sort.length>i;i++){var o=a.sort[i];r+=(i>0?",":"")+(o.descending?"-":"+")+encodeURIComponent(o.attribute)}r+=")"}var s={url:e+(null===r?"":r),dataType:n?"json":"text",contentType:n?"application/json":"text/plain",async:t.async,headers:{Accept:n?"application/json,application/javascript":"*/*"}};return a&&(a.start>=0||a.count>=0)&&(s.headers.Range="items="+(a.start||"0")+"-"+("count"in a&&1/0!=a.count?a.count+(a.start||0)-1:"")),s},o("put"),o("post"),o("delete"),s.servicePath=e,s},r._index={},r._timeStamps={},r._change=function(t,r,n,a){var i=r._getRequest(n,a);return i.data=a,e(t.toUpperCase(),i,r)},r._get=function(t,r,n){return n=n||{},e("GET",t._getRequest(r,n),t,n.start>=0||n.count>=0,r)},r}(rpc),function(t){function e(e){return{serialize:function(r,n,a){var i={id:this._requestId++,method:n.name,params:a};return e&&(i.jsonrpc=e),{data:t.toJson(i),dataType:"json",contentType:"application/json; charset=utf-8",transport:"POST"}},deserialize:function(t){if(t.error){var e=Error(t.error.message||t.error);return e._rpcErrorObject=t.error,e}return t.result}}}t.envelopeRegistry.register("JSON-RPC-1.0",function(t){return"JSON-RPC-1.0"==t},t.extend({namedParams:!1},e())),t.envelopeRegistry.register("JSON-RPC-2.0",function(t){return"JSON-RPC-2.0"==t},e("2.0"))}(rpc);