/*! Zeptor/jQuery RPC - v0.2.1 - 2013-04-18
* https://github.com/torworx/rpc
* Copyright 2013 Tao Yuan; Licensed MIT */
(function(e){function t(e){return null!==e&&e==e.window}function r(e){return"object"==o(e)}function n(e){if(!e||"object"!==o(e)||e.nodeType||t(e))return!1;try{if(e.constructor&&!g.call(e,"constructor")&&!g.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(r){return!1}var n;for(n in e);return void 0===n||g.call(e,n)}function a(e){return e instanceof Array}function i(e){return"number"==typeof e.length}function o(e){return null===e?e+"":p[h.call(e)]||"object"}function s(e,t,r){for(var i in t)r&&(n(t[i])||a(t[i]))?(n(t[i])&&!n(e[i])&&(e[i]={}),a(t[i])&&!a(e[i])&&(e[i]=[]),s(e[i],t[i],r)):void 0!==t[i]&&(e[i]=t[i])}function u(e,t,r,n){var a,i=$.isArray(t);m.each(t,function(t,o){a=m.type(o),n&&(t=r?n:n+"["+(i?"":t)+"]"),!n&&i?e.add(o.name,o.value):"array"==a||!r&&"object"==a?u(e,o,r,t):e.add(t,o)})}var c=e.rpc,l=Array.prototype,f=l.slice,p={},h=p.toString,g=p.hasOwnProperty,m=function(e,t){return new m.Service(e,t)};m.type=o,m.isPlainObject=n,m.isWindow=t,m.isObject=r,m.isArray=a,m.each=function(e,t){var r,n;if(i(e)){for(r=0;e.length>r;r++)if(t.call(e[r],r,e[r])===!1)return e}else for(n in e)if(t.call(e[n],n,e[n])===!1)return e;return e},m.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){p["[object "+t+"]"]=t.toLowerCase()}),m.extend=function(e){var t,r=f.call(arguments,1);return"boolean"==typeof e&&(t=e,e=r.shift()),r.forEach(function(r){s(e,r,t)}),e};var v=encodeURIComponent;m.param=function(e,t){var r=[];return r.add=function(e,t){this.push(v(e)+"="+v(t))},u(r,e,t),r.join("&").replace(/%20/g,"+")};var y=function(t,r){var n=f.call(arguments,2),a="string"===o(r);return function(){var i=f.call(arguments),o=a?(t||e)[r]:r;return o&&o.apply(t||this,n.concat(i))}};m.hitch=function(t,r){if(arguments.length>2)return y.apply(null,arguments);if(r||(r=t,t=null),"string"===o(r)){if(t=t||e,!t[r])throw['hitch: scope["',r,'"] is null (scope="',t,'")'].join("");return function(){return t[r].apply(t,arguments||[])}}return t?function(){return r.apply(t,arguments||[])}:r};var d=RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),j=RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$"),O=m.Url=function(){for(var e=null,t=arguments,r=[t[0]],n=1;t.length>n;n++)if(t[n]){var a=new O(t[n]+""),i=new O(r[0]+"");if(""!==a.path||a.scheme||a.authority||a.query){if(!a.scheme&&(a.scheme=i.scheme,!a.authority&&(a.authority=i.authority,"/"!=a.path.charAt(0)))){for(var o=i.path.substring(0,i.path.lastIndexOf("/")+1)+a.path,s=o.split("/"),u=0;s.length>u;u++)"."==s[u]?u==s.length-1?s[u]="":(s.splice(u,1),u--):u>0&&(1!=u||""!==s[0])&&".."==s[u]&&".."!=s[u-1]&&(u==s.length-1?(s.splice(u,1),s[u-1]=""):(s.splice(u-1,2),u-=2));a.path=s.join("/")}}else a.fragment!=e&&(i.fragment=a.fragment),a=i;r=[],a.scheme&&r.push(a.scheme,":"),a.authority&&r.push("//",a.authority),r.push(a.path),a.query&&r.push("?",a.query),a.fragment&&r.push("#",a.fragment)}this.uri=r.join("");var c=this.uri.match(d);this.scheme=c[2]||(c[1]?"":e),this.authority=c[4]||(c[3]?"":e),this.path=c[5],this.query=c[7]||(c[6]?"":e),this.fragment=c[9]||(c[8]?"":e),this.authority!=e&&(c=this.authority.match(j),this.user=c[3]||e,this.password=c[4]||e,this.host=c[6]||c[7],this.port=c[9]||e)};O.prototype.toString=function(){return this.uri};var S=m.AdapterRegistry=function(e){this.pairs=[],this.returnWrappers=e||!1};m.extend(S.prototype,{register:function(e,t,r,n,a){this.pairs[a?"unshift":"push"]([e,t,r,n])},match:function(){for(var e=0;this.pairs.length>e;e++){var t=this.pairs[e];if(t[1].apply(this,arguments))return t[3]||this.returnWrappers?t[2]:t[2].apply(this,arguments)}throw Error("No match found for '"+arguments[0]+"'")},unregister:function(e){for(var t=0;this.pairs.length>t;t++){var r=this.pairs[t];if(r[0]==e)return this.pairs.splice(t,1),!0}return!1}}),m.async=!0,m.noConflict=function(){return e.rpc===m&&(e.rpc=c),m},m.ajax=function(){alert("No adapter has been installed.")},m.installInto=function(e,t){e.rpc=m,m.ajax=e.ajax,t&&m.noConflict()},e.rpc=m})(window),function(rpc){"use strict";var _JSON,hasJSON="undefined"!=typeof JSON,hasJSONStringify=hasJSON&&'{"a":1}'==JSON.stringify({a:0},function(e,t){return t||1});if(hasJSONStringify)_JSON={parse:JSON.parse,stringify:JSON.stringify};else{var escapeString=function(e){return('"'+e.replace(/(["\\])/g,"\\$1")+'"').replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r")};_JSON={parse:hasJSON?JSON.parse:function(str,strict){if(strict&&!/^([\s\[\{]*(?:"(?:\\.|[^"])+"|-?\d[\d\.]*(?:[Ee][+-]?\d+)?|null|true|false|)[\s\]\}]*(?:,|:|$))+$/.test(str))throw new SyntaxError("Invalid characters in JSON");return eval("("+str+")")},stringify:function(e,t,r){function n(e,i,o){t&&(e=t(o,e));var s,u=typeof e;if("number"==u)return isFinite(e)?e+"":"null";if("boolean"==u)return e+"";if(null===e)return"null";if("string"==typeof e)return escapeString(e);if("function"==u||"undefined"==u)return a;if("function"==typeof e.toJSON)return n(e.toJSON(o),i,o);if(e instanceof Date)return'"{FullYear}-{Month+}-{Date}T{Hours}:{Minutes}:{Seconds}Z"'.replace(/\{(\w+)(\+)?\}/g,function(t,r,n){var a=e["getUTC"+r]()+(n?1:0);return 10>a?"0"+a:a});if(e.valueOf()!==e)return n(e.valueOf(),i,o);var c=r?i+r:"",l=r?" ":"",f=r?"\n":"";if(e instanceof Array){var p=e.length,h=[];for(o=0;p>o;o++){var g=e[o];s=n(g,c,o),"string"!=typeof s&&(s="null"),h.push(f+c+s)}return"["+h.join(",")+f+i+"]"}var m=[];for(o in e){var v;if(e.hasOwnProperty(o)){if("number"==typeof o)v='"'+o+'"';else{if("string"!=typeof o)continue;v=escapeString(o)}if(s=n(e[o],c,o),"string"!=typeof s)continue;m.push(f+c+v+":"+l+s)}}return"{"+m.join(",")+f+i+"}"}var a;return"string"==typeof t&&(r=t,t=null),n(e,"","")}}}_JSON.fromJson=function(js){return eval("("+js+")")};var toJsonIndentStr="	";_JSON.toJson=function(e,t){return _JSON.stringify(e,function(e,t){if(t){var r=t.__json__||t.json;if("function"==typeof r)return r.call(t)}return t},t&&toJsonIndentStr)},rpc.extend(rpc,_JSON)}(rpc),function(){var e,t,r,n,a,i,o,s,u,c,l,f,p,h=[].slice;a="1.3.2",t="pending",n="resolved",r="rejected",u=function(e,t){return null!==e?e.hasOwnProperty(t):void 0},l=function(e){return u(e,"length")&&u(e,"callee")},s=function(e){return l(e)?s(Array.prototype.slice.call(e)):Array.isArray(e)?e.reduce(function(e,t){return Array.isArray(t)?e.concat(s(t)):(e.push(t),e)},[]):[e]},i=function(e,t){return 0>=e?t():function(){return 1>--e?t.apply(this,arguments):void 0}},f=function(e,t){return function(){var r;return r=[e].concat(Array.prototype.slice.call(arguments,0)),t.apply(this,r)}},o=function(e,t,r){var n,a,i,o,u;for(o=s(e),u=[],a=0,i=o.length;i>a;a++)n=o[a],u.push(n.call.apply(n,[r].concat(h.call(t))));return u},e=function(){var a,i,u,c,l,f;return f=t,c=[],l=[],a=[],u={},this.promise=function(i){var p,h;return i=i||{},i.state=function(){return f},h=function(e,r){return function(){return f===t&&r.push.apply(r,s(arguments)),e()&&o(arguments,u),i}},i.done=h(function(){return f===n},c),i.fail=h(function(){return f===r},l),i.always=h(function(){return f!==t},a),p=function(t,r){var n,a;return n=new e,a=function(e,t,r){return r?e(function(){return t(r.apply(null,arguments))}):e(function(){return t.apply(null,arguments)})},a(i.done,n.resolve,t),a(i.fail,n.reject,r),n},i.pipe=p,i.then=p,i},this.promise(this),i=function(e,r,n){return function(){return f===t&&(f=e,u=arguments,o([r,a],u,n)),this}},this.resolve=i(n,c),this.reject=i(r,l),this.resolveWith=function(){var e,t;return t=arguments[0],e=arguments.length>=2?h.call(arguments,1):[],i(n,c,t).apply(null,e)},this.rejectWith=function(){var e,t;return t=arguments[0],e=arguments.length>=2?h.call(arguments,1):[],i(r,l,t).apply(null,e)},this},p=function(){var t,r,n,a,o,u,c,l;for(a=new e,r=s(arguments),n=i(r.length,a.resolve),o=0,c=r.length;c>o;o++)t=r[o],t.done(n);var f=function(){return a.reject()};for(u=0,l=r.length;l>u;u++)t=r[u],t.fail(f);return a.promise()},c=function(t){return t.Deferred=function(){return new e},t.ajax=f(t.ajax,function(t,r){var n,a;return null===r&&(r={}),a=new e,n=function(e,t){return f(e,function(){var e,r;return r=arguments[0],e=arguments.length>=2?h.call(arguments,1):[],r&&r.apply(null,e),t.apply(null,e)})},r.success=n(r.success,a.resolve),r.error=n(r.error,a.reject),t(r),a.promise()}),t.when=p,t.when},"undefined"!=typeof exports?(exports.Deferred=function(){return new e},exports.when=p,exports.installInto=c):(this.defer=function(){return new e},this.defer.when=p,this.defer.installInto=c)}.call(rpc),function(e){var t=e.Service=function(t,r){function n(t){var r;t._baseUrl=new e.Url(location.href,a||".")+"",i._smd=t;for(var n in i._smd.services){r=n.split(".");for(var o=i,s=0;r.length-1>s;s++)o=o[r[s]]||(o[r[s]]={});o[r[r.length-1]]=i._generateService(n,i._smd.services[n])}}var a,i=this;t&&("string"===e.type(t)||t instanceof e.Url?(a=t instanceof e.Url?t+"":t,e.ajax({url:a,async:!1,success:function(t){n("string"===e.type(t)?e.fromJson(t):t)},error:function(e,t,r){throw r}})):n(t)),this._options=r?r:{},this._requestId=0};e.extend(t.prototype,{_generateService:function(t,r){if(this[r])throw Error("WARNING: "+t+" already exists for service. Unable to generate function");r.name=t;var n=e.hitch(this,"_executeMethod",r),a=e.transportRegistry.match(r.transport||this._smd.transport);a.getExecutor&&(n=a.getExecutor(n,r,this));var i=r.returns||(r._schema={}),o="/"+t+"/";return i._service=n,n.servicePath=o,n._schema=i,n.id=e.Service._nextId++,n},_getRequest:function(t,r){var n,a,i=this._smd,o=e.envelopeRegistry.match(t.envelope||i.envelope||"NONE"),s=(t.parameters||[]).concat(i.parameters||[]);if(o.namedParams){if(1==r.length&&e.isPlainObject(r[0]))r=r[0];else{var u={};for(n=0;t.parameters.length>n;n++)void 0===r[n]&&t.parameters[n].optional||(u[t.parameters[n].name]=r[n]);r=u}if(t.strictParameters||i.strictParameters)for(n in r){var c=!1;for(a=0;s.length>a;a++)s[n].name==n&&(c=!0);c||delete r[n]}for(n=0;s.length>n;n++){var l=s[n];if(!l.optional&&l.name&&!r[l.name])if(l["default"])r[l.name]=l["default"];else if(!(l.name in r))throw Error("Required parameter "+l.name+" was omitted")}}else s&&s[0]&&s[0].name&&1==r.length&&e.isPlainObject(r[0])&&(r=o.namedParams===!1?e.toOrdered(s,r):r[0]);e.isPlainObject(this._options)&&(r=e.extend(r,this._options));var f=t._schema||t.returns,p=o.serialize.apply(this,[i,t,r]);p._envDef=o;var h=t.contentType||i.contentType||p.contentType;return e.extend(p,{async:e.async,contentType:h,headers:t.headers||i.headers||p.headers||{},target:p.target||e.getTarget(i,t),transport:t.transport||i.transport||p.transport,envelope:t.envelope||i.envelope||p.envelope,timeout:t.timeout||i.timeout,callbackParamName:t.callbackParamName||i.callbackParamName,rpcObjectParamName:t.rpcObjectParamName||i.rpcObjectParamName,schema:f,handleAs:p.handleAs||"auto",preventCache:t.preventCache||i.preventCache,frameDoc:this._options.frameDoc||void 0})},_executeMethod:function(t){for(var r=[],n=1;arguments.length>n;n++)r.push(arguments[n]);var a=this._getRequest(t,r),i=e.defer();return e.transportRegistry.match(a.transport).fire(e.extend({},a,{success:function(e){var t=a._envDef.deserialize.call(this,e);t instanceof Error?i.resolve(t,null):i.resolve(null,t)},error:function(e,t,r){i.resolve(r,null)}})),i}}),e.getTarget=function(t,r){var n=t._baseUrl;return t.target&&(n=new e.Url(n,t.target)+""),r.target&&(n=new e.Url(n,r.target)+""),n},e.toOrdered=function(t,r){if("array"===e.type(r))return r;for(var n=[],a=0;t.length>a;a++)n.push(r[t[a].name]);return n},e.transportRegistry=new e.AdapterRegistry(!0),e.envelopeRegistry=new e.AdapterRegistry(!0),e.envelopeRegistry.register("URL",function(e){return"URL"==e},{serialize:function(t,r,n){var a=e.param(n);return{data:a,transport:"POST"}},deserialize:function(e){return e},namedParams:!0}),e.envelopeRegistry.register("JSON",function(e){return"JSON"==e},{serialize:function(t,r,n){var a=e.toJson(n);return{data:a,dataType:"json",contentType:"application/json; charset=utf-8"}},deserialize:function(e){return e}}),e.envelopeRegistry.register("PATH",function(e){return"PATH"==e},{serialize:function(t,r,n){var a,i=e.getTarget(t,r);if("array"===e.type(n))for(a=0;n.length>a;a++)i+="/"+n[a];else for(a in n)i+="/"+a+"/"+n[a];return{data:"",target:i}},deserialize:function(e){return e}}),e.transportRegistry.register("POST",function(e){return"POST"==e},{fire:function(t){return t.url=t.target,t.type="POST",e.ajax(t)}}),e.transportRegistry.register("GET",function(e){return"GET"==e},{fire:function(t){return t.url=t.target+(t.data?"?"+(t.rpcObjectParamName?t.rpcObjectParamName+"=":"")+t.data:""),t.type="GET",t.data="",e.ajax(t)}}),e.transportRegistry.register("JSONP",function(e){return"JSONP"==e},{fire:function(t){return t.url=t.target+(-1==t.target.indexOf("?")?"?":"&")+(t.rpcObjectParamName?t.rpcObjectParamName+"=":"")+t.data,t.data="",t.dataType="jsonp",t.jsonp=t.callbackParamName||"callback",e.ajax(t)}}),e.Service._nextId=1,e.service=function(e,r){return new t(e,r)}}(rpc),function(e){function t(t,r,n,a){var i=e.defer(),o={type:t,success:function(e,t,r){a&&(a=r.getResponseHeader("Content-Range"),i.fullLength=a&&(a=a.match(/\/(.*)/))&&parseInt(a[1],0)),i.resolve(null,e)},error:function(e,t,r){i.resolve(r,null)}};return e.ajax(e.extend(o,r)),i}e&&e.transportRegistry&&e.transportRegistry.register("REST",function(e){return"REST"==e},{getExecutor:function(t,r,n){return new e.Rest(r.name,(r.contentType||n._smd.contentType||"").match(/json|javascript/),null,function(t,a){var i=n._getRequest(r,[]);return i.url=i.target+(t?"?"+e.param(t):""),a&&(a.start>=0||a.count>=0)&&(i.headers=i.headers||{},i.headers.Range="items="+(a.start||"0")+"-"+("count"in a&&1/0!=a.count?a.count+(a.start||0)-1:"")),i})}});var r;return r=e.Rest=function(t,n,a,i){function o(e){s[e]=function(t,n){return r._change(e,s,t,n)}}var s;return s=function(e,t){return r._get(s,e,t)},s.isJson=n,s._schema=a,s.cache={serialize:n?e.toJson:function(e){return e}},s._getRequest=i||function(r,a){if(e.isPlainObject(r)&&(r=e.param(r),r=r?"?"+r:""),a&&a.sort&&!a.queryStr){r+=(r?"&":"?")+"sort(";for(var i=0;a.sort.length>i;i++){var o=a.sort[i];r+=(i>0?",":"")+(o.descending?"-":"+")+encodeURIComponent(o.attribute)}r+=")"}var s={url:t+(null===r?"":r),dataType:n?"json":"text",contentType:n?"application/json":"text/plain",async:e.async,headers:{Accept:n?"application/json,application/javascript":"*/*"}};return a&&(a.start>=0||a.count>=0)&&(s.headers.Range="items="+(a.start||"0")+"-"+("count"in a&&1/0!=a.count?a.count+(a.start||0)-1:"")),s},o("put"),o("post"),o("delete"),s.servicePath=t,s},r._index={},r._timeStamps={},r._change=function(e,r,n,a){var i=r._getRequest(n,a);return i.data=a,t(e.toUpperCase(),i,r)},r._get=function(e,r,n){return n=n||{},t("GET",e._getRequest(r,n),e,n.start>=0||n.count>=0,r)},r}(rpc),function(e){function t(t){return{serialize:function(r,n,a){var i={id:this._requestId++,method:n.name,params:a};return t&&(i.jsonrpc=t),{data:e.toJson(i),dataType:"json",contentType:"application/json; charset=utf-8",transport:"POST"}},deserialize:function(e){if(e.error){var t=Error(e.error.message||e.error);return t._rpcErrorObject=e.error,t}return e.result}}}e.envelopeRegistry.register("JSON-RPC-1.0",function(e){return"JSON-RPC-1.0"==e},e.extend({namedParams:!1},t())),e.envelopeRegistry.register("JSON-RPC-2.0",function(e){return"JSON-RPC-2.0"==e},t("2.0"))}(rpc);