/*! Zeptor/jQuery RPC - v0.1.0 - 2013-03-20
* https://github.com/torworx/rpc
* Copyright 2013 Tao Yuan; Licensed MIT */
(function(r,e){var t=Array.prototype,n=t.slice,a={},i=function(t,a){var i=n.call(arguments,2),s="string"===r.type(a);return function(){var r=n.call(arguments),o=s?(t||e)[a]:a;return o&&o.apply(t||this,i.concat(r))}};a.hitch=function(t,n){if(arguments.length>2)return i.apply(null,arguments);if(n||(n=t,t=null),"string"===r.type(n)){if(t=t||e,!t[n])throw['hitch: scope["',n,'"] is null (scope="',t,'")'].join("");return function(){return t[n].apply(t,arguments||[])}}return t?function(){return n.apply(t,arguments||[])}:n};var s=RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),o=RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$"),u=a.Url=function(){for(var r=null,e=arguments,t=[e[0]],n=1;e.length>n;n++)if(e[n]){var a=new u(e[n]+""),i=new u(t[0]+"");if(""!==a.path||a.scheme||a.authority||a.query){if(!a.scheme&&(a.scheme=i.scheme,!a.authority&&(a.authority=i.authority,"/"!=a.path.charAt(0)))){for(var c=i.path.substring(0,i.path.lastIndexOf("/")+1)+a.path,p=c.split("/"),l=0;p.length>l;l++)"."==p[l]?l==p.length-1?p[l]="":(p.splice(l,1),l--):l>0&&(1!=l||""!==p[0])&&".."==p[l]&&".."!=p[l-1]&&(l==p.length-1?(p.splice(l,1),p[l-1]=""):(p.splice(l-1,2),l-=2));a.path=p.join("/")}}else a.fragment!=r&&(i.fragment=a.fragment),a=i;t=[],a.scheme&&t.push(a.scheme,":"),a.authority&&t.push("//",a.authority),t.push(a.path),a.query&&t.push("?",a.query),a.fragment&&t.push("#",a.fragment)}this.uri=t.join("");var f=this.uri.match(s);this.scheme=f[2]||(f[1]?"":r),this.authority=f[4]||(f[3]?"":r),this.path=f[5],this.query=f[7]||(f[6]?"":r),this.fragment=f[9]||(f[8]?"":r),this.authority!=r&&(f=this.authority.match(o),this.user=f[3]||r,this.password=f[4]||r,this.host=f[6]||f[7],this.port=f[9]||r)};u.prototype.toString=function(){return this.uri};var c=a.AdapterRegistry=function(r){this.pairs=[],this.returnWrappers=r||!1};r.extend(c.prototype,{register:function(r,e,t,n,a){this.pairs[a?"unshift":"push"]([r,e,t,n])},match:function(){for(var r=0;this.pairs.length>r;r++){var e=this.pairs[r];if(e[1].apply(this,arguments))return e[3]||this.returnWrappers?e[2]:e[2].apply(this,arguments)}throw Error("No match found for '"+arguments[0]+"'")},unregister:function(r){for(var e=0;this.pairs.length>e;e++){var t=this.pairs[e];if(t[0]==r)return this.pairs.splice(e,1),!0}return!1}}),a.async=!0,r.rpc=a})($,window),function($){"use strict";var _JSON,hasJSON="undefined"!=typeof JSON,hasJSONStringify=hasJSON&&'{"a":1}'==JSON.stringify({a:0},function(r,e){return e||1});if(hasJSONStringify)_JSON={parse:JSON.parse,stringify:JSON.stringify};else{var escapeString=function(r){return('"'+r.replace(/(["\\])/g,"\\$1")+'"').replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r")};_JSON={parse:hasJSON?JSON.parse:function(str,strict){if(strict&&!/^([\s\[\{]*(?:"(?:\\.|[^"])+"|-?\d[\d\.]*(?:[Ee][+-]?\d+)?|null|true|false|)[\s\]\}]*(?:,|:|$))+$/.test(str))throw new SyntaxError("Invalid characters in JSON");return eval("("+str+")")},stringify:function(r,e,t){function n(r,i,s){e&&(r=e(s,r));var o,u=typeof r;if("number"==u)return isFinite(r)?r+"":"null";if("boolean"==u)return r+"";if(null===r)return"null";if("string"==typeof r)return escapeString(r);if("function"==u||"undefined"==u)return a;if("function"==typeof r.toJSON)return n(r.toJSON(s),i,s);if(r instanceof Date)return'"{FullYear}-{Month+}-{Date}T{Hours}:{Minutes}:{Seconds}Z"'.replace(/\{(\w+)(\+)?\}/g,function(e,t,n){var a=r["getUTC"+t]()+(n?1:0);return 10>a?"0"+a:a});if(r.valueOf()!==r)return n(r.valueOf(),i,s);var c=t?i+t:"",p=t?" ":"",l=t?"\n":"";if(r instanceof Array){var f=r.length,h=[];for(s=0;f>s;s++){var g=r[s];o=n(g,c,s),"string"!=typeof o&&(o="null"),h.push(l+c+o)}return"["+h.join(",")+l+i+"]"}var m=[];for(s in r){var v;if(r.hasOwnProperty(s)){if("number"==typeof s)v='"'+s+'"';else{if("string"!=typeof s)continue;v=escapeString(s)}if(o=n(r[s],c,s),"string"!=typeof o)continue;m.push(l+c+v+":"+p+o)}}return"{"+m.join(",")+l+i+"}"}var a;return"string"==typeof e&&(t=e,e=null),n(r,"","")}}}_JSON.fromJson=function(js){return eval("("+js+")")};var toJsonIndentStr="	";_JSON.toJson=function(r,e){return _JSON.stringify(r,function(r,e){if(e){var t=e.__json__||e.json;if("function"==typeof t)return t.call(e)}return e},e&&toJsonIndentStr)},$.extend($.rpc,_JSON)}($),function(r){var e,t,n,a,i,s,o,u,c,p,l,f=[].slice;t="pending",a="resolved",n="rejected",u=function(r,e){return null!==r?r.hasOwnProperty(e):void 0},c=function(r){return u(r,"length")&&u(r,"callee")},o=function(r){return c(r)?o(Array.prototype.slice.call(r)):Array.isArray(r)?r.reduce(function(r,e){return Array.isArray(e)?r.concat(o(e)):(r.push(e),r)},[]):[r]},i=function(r,e){return 0>=r?e():function(){return 1>--r?e.apply(this,arguments):void 0}},p=function(r,e){return function(){var t;return t=[r].concat(Array.prototype.slice.call(arguments,0)),e.apply(this,t)}},s=function(r,e,t){var n,a,i,s,u;for(s=o(r),u=[],a=0,i=s.length;i>a;a++)n=s[a],u.push(n.call.apply(n,[t].concat(f.call(e))));return u},e=function(){var r,i,u,c,p,l;return l=t,c=[],p=[],r=[],u={},this.promise=function(i){var f,h;return i=i||{},i.state=function(){return l},h=function(r,e){return function(){return l===t&&e.push.apply(e,o(arguments)),r()&&s(arguments,u),i}},f=function(r,t){var n,a;return n=new e,a=function(r,e,t){return t?r(function(){return e(t.apply(null,arguments))}):r(function(){return e.apply(null,arguments)})},a(i.done,n.resolve,r),a(i.fail,n.reject,t),n},i.done=h(function(){return l===a},c),i.fail=h(function(){return l===n},p),i.always=h(function(){return l!==t},r),i.pipe=f,i.then=f,i},this.promise(this),i=function(e,n,a){return function(){return l===t&&(l=e,u=arguments,s([n,r],u,a)),this}},this.resolve=i(a,c),this.reject=i(n,p),this.resolveWith=function(){var r,e;return e=arguments[0],r=arguments.length>=2?f.call(arguments,1):[],i(a,c,e).apply(null,r)},this.rejectWith=function(){var r,e;return e=arguments[0],r=arguments.length>=2?f.call(arguments,1):[],i(n,p,e).apply(null,r)},this},l=function(){var r,t,n,a,s,u,c,p,l;for(s=new e,t=o(arguments),n=i(t.length,s.resolve),u=0,p=t.length;p>u;u++)r=t[u],r.done(n);for(a=function(){return s.reject()},c=0,l=t.length;l>c;c++)r=t[c],r.fail(a);return s.promise()},r.rpc.Deferred=function(){return new e},r.rpc.Deferred.when=l}($),function(r,e){var t=r.rpc.Service=function(e,t){function n(e){var t;e._baseUrl=new r.rpc.Url(location.href,a||".")+"",i._smd=e;for(var n in i._smd.services){t=n.split(".");for(var s=i,o=0;t.length-1>o;o++)s=s[t[o]]||(s[t[o]]={});s[t[t.length-1]]=i._generateService(n,i._smd.services[n])}}var a,i=this;e&&("string"===r.type(e)||e instanceof r.rpc.Url?(a=e instanceof r.rpc.Url?e+"":e,r.ajax({url:a,async:!1,success:function(e){n(r.rpc.fromJson(e))},error:function(r,e,t){throw t}})):n(e)),this._options=t?t:{},this._requestId=0};r.extend(t.prototype,{_generateService:function(e,t){if(this[t])throw Error("WARNING: "+e+" already exists for service. Unable to generate function");t.name=e;var n=r.rpc.hitch(this,"_executeMethod",t),a=r.rpc.transportRegistry.match(t.transport||this._smd.transport);a.getExecutor&&(n=a.getExecutor(n,t,this));var i=t.returns||(t._schema={}),s="/"+e+"/";return i._service=n,n.servicePath=s,n._schema=i,n.id=r.rpc.Service._nextId++,n},_getRequest:function(t,n){var a,i,s=this._smd,o=r.rpc.envelopeRegistry.match(t.envelope||s.envelope||"NONE"),u=(t.parameters||[]).concat(s.parameters||[]);if(o.namedParams){if(1==n.length&&r.isPlainObject(n[0]))n=n[0];else{var c={};for(a=0;t.parameters.length>a;a++)n[a]===e&&t.parameters[a].optional||(c[t.parameters[a].name]=n[a]);n=c}if(t.strictParameters||s.strictParameters)for(a in n){var p=!1;for(i=0;u.length>i;i++)u[a].name==a&&(p=!0);p||delete n[a]}for(a=0;u.length>a;a++){var l=u[a];if(!l.optional&&l.name&&!n[l.name])if(l["default"])n[l.name]=l["default"];else if(!(l.name in n))throw Error("Required parameter "+l.name+" was omitted")}}else u&&u[0]&&u[0].name&&1==n.length&&r.isPlainObject(n[0])&&(n=o.namedParams===!1?r.rpc.toOrdered(u,n):n[0]);r.isPlainObject(this._options)&&(n=r.extend(n,this._options));var f=t._schema||t.returns,h=o.serialize.apply(this,[s,t,n]);h._envDef=o;var g=t.contentType||s.contentType||h.contentType;return r.extend(h,{async:r.rpc.async,contentType:g,headers:t.headers||s.headers||h.headers||{},target:h.target||r.rpc.getTarget(s,t),transport:t.transport||s.transport||h.transport,envelope:t.envelope||s.envelope||h.envelope,timeout:t.timeout||s.timeout,callbackParamName:t.callbackParamName||s.callbackParamName,rpcObjectParamName:t.rpcObjectParamName||s.rpcObjectParamName,schema:f,handleAs:h.handleAs||"auto",preventCache:t.preventCache||s.preventCache,frameDoc:this._options.frameDoc||e})},_executeMethod:function(e){for(var t=[],n=1;arguments.length>n;n++)t.push(arguments[n]);var a=this._getRequest(e,t),i=r.rpc.Deferred();return r.rpc.transportRegistry.match(a.transport).fire(r.extend({},a,{success:function(r){var e=a._envDef.deserialize.call(this,r);e instanceof Error?i.resolve(e,null):i.resolve(null,e)},error:function(r,e,t){i.resolve(t,null)}})),i}}),r.rpc.getTarget=function(e,t){var n=e._baseUrl;return e.target&&(n=new r.rpc.Url(n,e.target)+""),t.target&&(n=new r.rpc.Url(n,t.target)+""),n},r.rpc.toOrdered=function(e,t){if("array"===r.type(t))return t;for(var n=[],a=0;e.length>a;a++)n.push(t[e[a].name]);return n},r.rpc.transportRegistry=new r.rpc.AdapterRegistry(!0),r.rpc.envelopeRegistry=new r.rpc.AdapterRegistry(!0),r.rpc.envelopeRegistry.register("URL",function(r){return"URL"==r},{serialize:function(e,t,n){var a=r.param(n);return{data:a,transport:"POST"}},deserialize:function(r){return r},namedParams:!0}),r.rpc.envelopeRegistry.register("JSON",function(r){return"JSON"==r},{serialize:function(e,t,n){var a=r.rpc.toJson(n);return{data:a,dataType:"json",contentType:"application/json; charset=utf-8"}},deserialize:function(r){return r}}),r.rpc.envelopeRegistry.register("PATH",function(r){return"PATH"==r},{serialize:function(e,t,n){var a,i=r.rpc.getTarget(e,t);if("array"===r.type(n))for(a=0;n.length>a;a++)i+="/"+n[a];else for(a in n)i+="/"+a+"/"+n[a];return{data:"",target:i}},deserialize:function(r){return r}}),r.rpc.transportRegistry.register("POST",function(r){return"POST"==r},{fire:function(e){return e.url=e.target,e.type="POST",r.ajax(e)}}),r.rpc.transportRegistry.register("GET",function(r){return"GET"==r},{fire:function(e){return e.url=e.target+(e.data?"?"+(e.rpcObjectParamName?e.rpcObjectParamName+"=":"")+e.data:""),e.type="GET",e.data="",r.ajax(e)}}),r.rpc.transportRegistry.register("JSONP",function(r){return"JSONP"==r},{fire:function(e){return e.url=e.target+(-1==e.target.indexOf("?")?"?":"&")+(e.rpcObjectParamName?e.rpcObjectParamName+"=":"")+e.data,e.data="",e.dataType="jsonp",e.jsonp=e.callbackParamName||"callback",r.ajax(e)}}),r.rpc.Service._nextId=1,r.rpc.service=function(r,e){return new t(r,e)}}($),function(r){function e(e,t,n,a){var i=r.rpc.Deferred(),s={type:e,success:function(r,e,t){a&&(a=t.getResponseHeader("Content-Range"),i.fullLength=a&&(a=a.match(/\/(.*)/))&&parseInt(a[1],0)),i.resolve(null,r)},error:function(r,e,t){i.resolve(t,null)}};return r.ajax(r.extend(s,t)),i}r.rpc&&r.rpc.transportRegistry&&r.rpc.transportRegistry.register("REST",function(r){return"REST"==r},{getExecutor:function(e,t,n){return new r.rpc.Rest(t.name,(t.contentType||n._smd.contentType||"").match(/json|javascript/),null,function(e,a){var i=n._getRequest(t,[]);return i.url=i.target+(e?"?"+r.param(e):""),a&&(a.start>=0||a.count>=0)&&(i.headers=i.headers||{},i.headers.Range="items="+(a.start||"0")+"-"+("count"in a&&1/0!=a.count?a.count+(a.start||0)-1:"")),i})}});var t;return t=r.rpc.Rest=function(e,n,a,i){function s(r){o[r]=function(e,n){return t._change(r,o,e,n)}}var o;return o=function(r,e){return t._get(o,r,e)},o.isJson=n,o._schema=a,o.cache={serialize:n?r.rpc.toJson:function(r){return r}},o._getRequest=i||function(t,a){if(r.isPlainObject(t)&&(t=r.param(t),t=t?"?"+t:""),a&&a.sort&&!a.queryStr){t+=(t?"&":"?")+"sort(";for(var i=0;a.sort.length>i;i++){var s=a.sort[i];t+=(i>0?",":"")+(s.descending?"-":"+")+encodeURIComponent(s.attribute)}t+=")"}var o={url:e+(null===t?"":t),dataType:n?"json":"text",contentType:n?"application/json":"text/plain",async:r.rpc.async,headers:{Accept:n?"application/json,application/javascript":"*/*"}};return a&&(a.start>=0||a.count>=0)&&(o.headers.Range="items="+(a.start||"0")+"-"+("count"in a&&1/0!=a.count?a.count+(a.start||0)-1:"")),o},s("put"),s("post"),s("delete"),o.servicePath=e,o},t._index={},t._timeStamps={},t._change=function(r,t,n,a){var i=t._getRequest(n,a);return i.data=a,e(r.toUpperCase(),i,t)},t._get=function(r,t,n){return n=n||{},e("GET",r._getRequest(t,n),r,n.start>=0||n.count>=0,t)},t}($),function(r){function e(e){return{serialize:function(t,n,a){var i={id:this._requestId++,method:n.name,params:a};return e&&(i.jsonrpc=e),{data:r.rpc.toJson(i),dataType:"json",contentType:"application/json; charset=utf-8",transport:"POST"}},deserialize:function(r){if(r.error){var e=Error(r.error.message||r.error);return e._rpcErrorObject=r.error,e}return r.result}}}r.rpc.envelopeRegistry.register("JSON-RPC-1.0",function(r){return"JSON-RPC-1.0"==r},r.extend({namedParams:!1},e())),r.rpc.envelopeRegistry.register("JSON-RPC-2.0",function(r){return"JSON-RPC-2.0"==r},e("2.0"))}($);